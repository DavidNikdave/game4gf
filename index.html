<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Leisha's Heart Runner üíñ</title>

<style>
  body{margin:0;overflow:hidden;font-family:Arial,sans-serif;background:linear-gradient(to top,#ff5fa2,#ffc3e6)}
  #game{width:100vw;height:100vh;position:relative}

  #player{
    width:58px;height:58px;position:absolute;display:none;
    border-radius:18px;overflow:hidden;
    box-shadow:0 14px 40px rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.75);
    background: rgba(255,255,255,0.20);
    z-index: 999;
  }
  #playerImg{
    width:100%;height:100%;
    object-fit: cover;
    object-position: 50% 40%;
    display:none;
  }

  /* Kawaii cube fallback (never invisible) */
  #playerKawaii{
    width:100%;height:100%;
    border-radius:18px;
    background:linear-gradient(145deg,#ffffff,#ffe0ee);
    display:block;
    position:relative;
  }
  #playerKawaii::before{
    content:"";
    position:absolute;left:14px;top:20px;width:9px;height:9px;border-radius:50%;
    background:#2b2b2b;
    box-shadow:22px 0 0 #2b2b2b;
  }
  #playerKawaii::after{
    content:"";
    position:absolute;left:20px;top:34px;width:18px;height:10px;border-radius:0 0 14px 14px;
    border:3px solid #ff4f9a;border-top:0;
    box-shadow:-10px -8px 0 0 rgba(255,120,170,.35), 28px  -8px 0 0 rgba(255,120,170,.35);
  }

  .heart,.obstacle{position:absolute;font-size:30px;user-select:none;z-index:5}
  .obstacle{font-size:40px}

  #score{
    position:absolute;top:12px;left:12px;color:#fff;font-size:22px;display:none;
    text-shadow:0 2px 10px rgba(0,0,0,.25);
    z-index: 1000;
  }

  .screen{
    position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
    text-align:center;color:#fff;padding:20px;box-sizing:border-box;
  }

  button{
    font-size:22px;padding:10px 20px;margin:10px;border:0;border-radius:12px;cursor:pointer
  }

  .panel{
    width:min(860px,94vw);
    background:rgba(0,0,0,.20);
    border:1px solid rgba(255,255,255,.25);
    border-radius:16px;
    padding:14px 16px;
    box-shadow:0 14px 40px rgba(0,0,0,.18);
    backdrop-filter: blur(8px);
  }

  .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;align-items:flex-end;margin-top:10px}

  select{
    font-size:18px;padding:10px 12px;border-radius:12px;border:0;outline:none;cursor:pointer
  }

  #skinPreview{
    width:54px;height:54px;border-radius:14px;overflow:hidden;
    border:2px solid rgba(255,255,255,0.65);
    background:rgba(255,255,255,0.20);
    box-shadow:0 10px 25px rgba(0,0,0,.18);
    flex:0 0 auto;
    position:relative;
  }
  #skinPreview img{
    width:100%;height:100%;
    object-fit: cover;
    object-position: 50% 40%;
    display:block;
  }

  #yesBtn{background:#4CAF50;color:#fff;position:relative;z-index:60}
  #noBtn{background:#ff3b3b;color:#fff;position:fixed;z-index:50;display:none}

  #question{font-size:36px;margin-bottom:18px;text-shadow:0 2px 12px rgba(0,0,0,.25)}
  #btnRow{display:flex;gap:14px;align-items:center;justify-content:center;margin-top:8px}

  #finalMsg{
    display:none;font-size:44px;line-height:1.15;margin-top:8px;
    text-shadow:0 2px 14px rgba(0,0,0,.25)
  }

  #mapCard{
    display:none;margin-top:16px;border-radius:14px;overflow:hidden;
    width:min(720px,92vw);height:min(360px,45vh);
    box-shadow:0 14px 40px rgba(0,0,0,.25);
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.22);
    position:relative;
  }
  #mapCard .topbar{
    position:absolute;left:0;right:0;top:0;height:44px;
    background:rgba(0,0,0,.25);backdrop-filter: blur(8px);
    display:flex;align-items:center;gap:10px;padding:0 12px;color:#fff;font-weight:700;
    z-index:2
  }
  #mapCard .topbar a{color:#fff;text-decoration:underline;font-weight:700}
  #mapFrame{position:absolute;inset:0;border:0;width:100%;height:100%}

  #infoCard{
    display:none;margin-top:12px;width:min(720px,92vw);
    border-radius:14px;padding:14px 16px;
    background:rgba(255, 245, 250, 0.92);color:#3b2b33;
    box-shadow:0 14px 40px rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.9);text-align:left;
  }
  #infoCard .title{font-weight:900;font-size:18px;margin-bottom:6px}
  #infoCard .r{display:flex;gap:10px;align-items:center;margin:6px 0;font-weight:800}
  #infoCard .note{margin-top:8px;font-weight:700;opacity:0.92}

  #restartBtn, #shotBtn{
    display:none;margin-top:10px;
    background:rgba(255,255,255,.92);
    color:#ff3b88;font-weight:900;
  }

  #confetti{position:fixed;inset:0;pointer-events:none;display:none;z-index:9999}

  .shake { animation: shake 0.22s linear 1; }
  @keyframes shake {
    0%{transform:translate(0,0)}
    25%{transform:translate(6px,-3px)}
    50%{transform:translate(-6px,3px)}
    75%{transform:translate(5px,2px)}
    100%{transform:translate(0,0)}
  }

  #gameOverScreen h1{font-size:52px;margin:0}
  #gameOverScreen p{font-size:22px;margin:12px 0 0}

  .hint{opacity:.95;font-size:16px;margin-top:8px}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div id="game">

  <!-- START SCREEN -->
  <div id="startScreen" class="screen">
    <h1 style="margin:0 0 10px;">üíñ Leisha's Heart Runner üíñ</h1>

    <div class="panel">
      <div style="font-size:18px;font-weight:900;">Sammle Herzen üíñ & weiche üíî aus</div>
      <div class="hint">Steuerung: ‚Üê ‚Üí ‚Üë ‚Üì gedr√ºckt halten</div>

      <div class="row">
        <div style="text-align:left;">
          <div style="font-weight:900;margin-bottom:6px;">Modus</div>
          <select id="modeSel">
            <option value="story" selected>Story (10 Herzen, üíî = -1)</option>
            <option value="endless">Endless (üíî = sofort tot)</option>
          </select>
        </div>

        <div style="text-align:left;">
          <div style="font-weight:900;margin-bottom:6px;">Skin</div>
          <div style="display:flex;gap:12px;align-items:center;">
            <select id="skinSel">
              <option value="Leisha.png">Leisha (OG)</option>
              <option value="cosy.png">Cosy</option>
              <option value="pouty.png">Pouty</option>
              <option value="sweet.png">Sweet</option>
              <option value="sweet2.png">Sweet 2</option>
              <option value="chic.png">Chic</option>
            </select>
            <div id="skinPreview" title="Preview"></div>
          </div>
        </div>
      </div>

      <div class="hint">Klick auf START, damit Musik & Sounds sicher starten üéµ</div>
      <button id="startBtn">START</button>

      <div class="hint">
        Dateien im gleichen Ordner:<br>
        <b>Leisha.png</b>, cosy.png, pouty.png, sweet.png, sweet2.png, chic.png
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div id="player">
    <img id="playerImg" src="" alt="Skin" />
    <div id="playerKawaii"></div>
  </div>

  <div id="score">Hearts: 0 / 10</div>

  <!-- VALENTINE SCREEN -->
  <div id="valentineBox" class="screen" style="display:none;">
    <div id="question">Leisha, will you be my Valentine? üíò</div>

    <div id="btnRow">
      <button id="yesBtn">YES üíñ</button>
    </div>

    <div id="finalMsg">Yaaay üíñ Danke Leisha!<br>Ich freu mich so sehr auf unseren Tag ü•∞</div>

    <div id="mapCard">
      <div class="topbar">
        üìç St. Marx Halle
        <span style="opacity:.9;font-weight:600;">‚Ä¢</span>
        <a id="gmLink" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
      </div>
      <iframe id="mapFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

    <div id="infoCard">
      <div class="title">‚ú® Infos</div>
      <div class="r">üìÖ <span>Datum:</span> 14.02.2026</div>
      <div class="r">üïë <span>Uhrzeit:</span> 14:00 Uhr</div>
      <div class="r">üìç <span>Treffpunkt:</span> St. Marx Halle</div>
      <div class="note">Und gute Laune mitnehmen üòÑ</div>
    </div>

    <button id="restartBtn">Restart üîÅ</button>
    <button id="shotBtn">üì∏ Screenshot speichern</button>
  </div>

  <!-- GAME OVER SCREEN -->
  <div id="gameOverScreen" class="screen" style="display:none;">
    <div class="panel">
      <h1>üíî Game Over</h1>
      <p id="goText">Zu viele gebrochene Herzen üò¢</p>
      <button onclick="location.reload()">Restart üîÅ</button>
    </div>
  </div>

  <button id="noBtn">NO üòú</button>
</div>

<script>
  const game = document.getElementById("game");

  const startScreen = document.getElementById("startScreen");
  const startBtn = document.getElementById("startBtn");
  const skinSel = document.getElementById("skinSel");
  const modeSel = document.getElementById("modeSel");
  const skinPreview = document.getElementById("skinPreview");

  const player = document.getElementById("player");
  const playerImg = document.getElementById("playerImg");
  const playerKawaii = document.getElementById("playerKawaii");
  const scoreText = document.getElementById("score");

  const box = document.getElementById("valentineBox");
  const question = document.getElementById("question");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");

  const finalMsg = document.getElementById("finalMsg");
  const restartBtn = document.getElementById("restartBtn");
  const shotBtn = document.getElementById("shotBtn");

  const mapCard = document.getElementById("mapCard");
  const mapFrame = document.getElementById("mapFrame");
  const gmLink = document.getElementById("gmLink");

  const infoCard = document.getElementById("infoCard");
  const gameOverScreen = document.getElementById("gameOverScreen");
  const goText = document.getElementById("goText");

  const confettiCanvas = document.getElementById("confetti");
  const ctx2d = confettiCanvas.getContext("2d");

  // ---------- Preview render ----------
  function renderSkinPreview(fileName){
    // fallback kawaii preview
    skinPreview.innerHTML = `
      <div style="
        width:100%;height:100%;
        border-radius:14px;
        background:linear-gradient(145deg,#ffffff,#ffe0ee);
        position:relative;
      ">
        <div style="
          position:absolute;left:14px;top:19px;width:8px;height:8px;border-radius:50%;
          background:#2b2b2b;box-shadow:18px 0 0 #2b2b2b;
        "></div>
        <div style="
          position:absolute;left:18px;top:32px;width:16px;height:10px;border-radius:0 0 12px 12px;
          border:3px solid #ff4f9a;border-top:0;
        "></div>
      </div>
    `;

    const img = new Image();
    img.onload = () => {
      skinPreview.innerHTML = "";
      const el = document.createElement("img");
      el.src = fileName;
      el.alt = "preview";
      skinPreview.appendChild(el);
    };
    img.onerror = () => { /* keep fallback */ };
    img.src = fileName;
  }
  renderSkinPreview(skinSel.value);
  skinSel.addEventListener("change", ()=> renderSkinPreview(skinSel.value));

  // ---------- SKIN LOADER (never invisible) ----------
  function setSkin(fileName){
    playerImg.style.display = "none";
    playerKawaii.style.display = "block";
    playerImg.src = "";

    const test = new Image();
    test.onload = () => {
      playerImg.src = fileName;
      playerImg.style.display = "block";
      playerKawaii.style.display = "none";
    };
    test.onerror = () => {
      console.warn("Skin missing / not loadable:", fileName);
      playerImg.style.display = "none";
      playerKawaii.style.display = "block";
    };
    test.src = fileName;
  }

  // ---------- Game state ----------
  let playerX = window.innerWidth / 2;
  let playerY = window.innerHeight - 100;

  let score = 0;
  let keys = {};
  let gameRunning = false;

  let isEndless = false;
  let targetHearts = 10;

  const heartInterval = 1100;
  const obstacleInterval = 2000;
  const heartSpeed = 5;
  const obstacleSpeed = 6;

  let heartTimer = null;
  let obstacleTimer = null;

  function updateScore(){
    if(isEndless){
      scoreText.textContent = `Score: ${score}`;
    } else {
      scoreText.textContent = `Hearts: ${score} / ${targetHearts}`;
    }
  }

  function clearTimers(){
    if(heartTimer) clearInterval(heartTimer);
    if(obstacleTimer) clearInterval(obstacleTimer);
    heartTimer = null;
    obstacleTimer = null;
  }

  // ---------- WebAudio ----------
  let audioCtx = null;
  let musicTimer = null;
  let musicStep = 0;

  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state !== "running") audioCtx.resume();
  }

  const melodyMain = [523.25,659.25,783.99,659.25,587.33,698.46,880.00,698.46,523.25,659.25,783.99,987.77,493.88,659.25,783.99,659.25];
  const melodySoft = [392.00,440.00,493.88,440.00,349.23,392.00,440.00,392.00,329.63,392.00,440.00,392.00,293.66,349.23,392.00,349.23];

  function playNote(freq, duration=0.16, type="triangle", volume=0.08){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t);
    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(volume, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(t); osc.stop(t + duration + 0.02);
  }

  function stopMusic(){ if(musicTimer){ clearInterval(musicTimer); musicTimer=null; } }

  function startMusic(mode){
    ensureAudio();
    stopMusic();
    musicStep = 0;

    const seq = (mode === "soft") ? melodySoft : melodyMain;
    const interval = (mode === "soft") ? 240 : 170;
    const leadVol = (mode === "soft") ? 0.055 : 0.075;

    musicTimer = setInterval(() => {
      const f = seq[musicStep % seq.length];
      playNote(f, (mode==="soft") ? 0.22 : 0.16, (mode==="soft") ? "sine" : "triangle", leadVol);
      if(musicStep % 4 === 0){
        playNote(f/4, (mode==="soft") ? 0.30 : 0.22, "sine", (mode==="soft") ? 0.04 : 0.05);
      }
      musicStep++;
    }, interval);
  }

  function musicDropToSoft(){
    ensureAudio();
    playNote(660, 0.08, "triangle", 0.08);
    setTimeout(()=>playNote(440, 0.10, "triangle", 0.07), 90);
    setTimeout(()=>playNote(330, 0.12, "sine", 0.06), 190);
    stopMusic();
    setTimeout(()=>startMusic("soft"), 800);
  }

  function playHeartSfx(){ ensureAudio(); playNote(880, 0.08, "square", 0.07); playNote(660, 0.10, "triangle", 0.05); }
  function playBrokenSfx(){ ensureAudio(); playNote(220, 0.10, "sawtooth", 0.07); playNote(164.81, 0.14, "triangle", 0.06); playNote(120, 0.08, "square", 0.03); }
  function playGameOverSfx(){ ensureAudio(); playNote(196, 0.25, "sine", 0.08); setTimeout(()=>playNote(147, 0.35, "triangle", 0.06), 220); }

  // ---------- FX ----------
  function burstEmoji(x, y, emoji, count=10){
    for(let i=0;i<count;i++){
      const p = document.createElement("div");
      p.textContent = emoji;
      p.style.position = "fixed";
      p.style.left = x + "px";
      p.style.top  = y + "px";
      p.style.fontSize = (14 + Math.random()*16) + "px";
      p.style.pointerEvents = "none";
      p.style.zIndex = 9999;
      document.body.appendChild(p);

      const vx = (Math.random()*2-1) * 3.4;
      const vy = -(2.5 + Math.random()*3.8);
      let life = 0;

      const t = setInterval(() => {
        life++;
        p.style.left = (parseFloat(p.style.left) + vx) + "px";
        p.style.top  = (parseFloat(p.style.top) + vy + life*0.16) + "px";
        p.style.opacity = String(Math.max(0, 1 - life/34));
        if(life > 34){ clearInterval(t); p.remove(); }
      }, 16);
    }
  }

  function screenShake(){
    document.body.classList.remove("shake");
    void document.body.offsetWidth;
    document.body.classList.add("shake");
    setTimeout(()=>document.body.classList.remove("shake"), 260);
  }

  function checkCollision(el){
    const p = player.getBoundingClientRect();
    const e = el.getBoundingClientRect();
    return e.bottom > p.top && e.top < p.bottom && e.left < p.right && e.right > p.left;
  }

  // ---------- Movement ----------
  document.addEventListener("keydown", e => keys[e.key] = true);
  document.addEventListener("keyup", e => keys[e.key] = false);

  function movePlayer(){
    if(gameRunning){
      if(keys["ArrowLeft"])  playerX -= 7;
      if(keys["ArrowRight"]) playerX += 7;
      if(keys["ArrowUp"])    playerY -= 7;
      if(keys["ArrowDown"])  playerY += 7;

      playerX = Math.max(0, Math.min(window.innerWidth - 58, playerX));
      playerY = Math.max(0, Math.min(window.innerHeight - 58, playerY));

      player.style.left = playerX + "px";
      player.style.top  = playerY + "px";
    }
    requestAnimationFrame(movePlayer);
  }
  movePlayer();

  // ---------- Spawns ----------
  function spawnHeart(){
    if(!gameRunning) return;
    if(!isEndless && score >= targetHearts) return;

    const heart = document.createElement("div");
    heart.className = "heart";
    heart.textContent = "üíñ";
    heart.style.left = (Math.random() * (window.innerWidth - 30)) + "px";
    heart.style.top  = "-30px";
    game.appendChild(heart);

    const fall = setInterval(() => {
      heart.style.top = (parseInt(heart.style.top) + heartSpeed) + "px";

      if(checkCollision(heart)){
        // In endless: use as score counter
        score++;
        playHeartSfx();
        updateScore();

        const pr = player.getBoundingClientRect();
        burstEmoji(pr.left + pr.width/2, pr.top + pr.height/2, "üíó", 10);

        heart.remove();
        clearInterval(fall);

        if(!isEndless && score >= targetHearts) endGame();
      }

      if(parseInt(heart.style.top) > window.innerHeight){
        heart.remove();
        clearInterval(fall);
      }
    }, 30);
  }

  function spawnObstacle(){
    if(!gameRunning) return;

    const obs = document.createElement("div");
    obs.className = "obstacle";
    obs.textContent = "üíî";
    obs.style.left = (Math.random() * (window.innerWidth - 30)) + "px";
    obs.style.top  = "-30px";
    game.appendChild(obs);

    const fall = setInterval(() => {
      obs.style.top = (parseInt(obs.style.top) + obstacleSpeed) + "px";

      if(checkCollision(obs)){
        // Endless: instant death
        if(isEndless){
          playBrokenSfx();
          screenShake();
          obs.remove();
          clearInterval(fall);
          triggerGameOver("Endless vorbei üò≠ (üíî getroffen)");
          return;
        }

        // Story: -1 heart
        score--;
        updateScore();
        playBrokenSfx();
        screenShake();

        const pr = player.getBoundingClientRect();
        burstEmoji(pr.left + pr.width/2, pr.top + pr.height/2, "üí•", 7);

        obs.remove();
        clearInterval(fall);

        if(score < 0) triggerGameOver("Zu viele gebrochene Herzen üò¢");
      }

      if(parseInt(obs.style.top) > window.innerHeight){
        obs.remove();
        clearInterval(fall);
      }
    }, 30);
  }

  function startSpawners(){
    clearTimers();
    heartTimer = setInterval(spawnHeart, heartInterval);
    obstacleTimer = setInterval(spawnObstacle, obstacleInterval);
  }

  // ---------- End states ----------
  function triggerGameOver(msg){
    gameRunning = false;
    clearTimers();
    stopMusic();
    playGameOverSfx();
    goText.textContent = msg || "Game Over";
    gameOverScreen.style.display = "flex";
  }

  function endGame(){
    gameRunning = false;
    clearTimers();
    musicDropToSoft();

    box.style.display = "flex";
    question.style.display = "block";
    finalMsg.style.display = "none";
    mapCard.style.display = "none";
    infoCard.style.display = "none";
    restartBtn.style.display = "none";
    shotBtn.style.display = "none";

    yesBtn.style.display = "inline-block";
    noBtn.style.display = "block";

    const yesRect = yesBtn.getBoundingClientRect();
    noBtn.style.left = Math.min(window.innerWidth - 120, yesRect.right + 14) + "px";
    noBtn.style.top  = yesRect.top + "px";
  }

  function fleeNo(){
    const pad = 14;
    const maxX = window.innerWidth - noBtn.offsetWidth - pad;
    const maxY = window.innerHeight - noBtn.offsetHeight - pad;
    noBtn.style.left = (pad + Math.random() * Math.max(1, maxX - pad)) + "px";
    noBtn.style.top  = (pad + Math.random() * Math.max(1, maxY - pad)) + "px";
  }
  noBtn.addEventListener("mouseover", fleeNo);
  noBtn.addEventListener("mousedown", fleeNo);
  noBtn.addEventListener("touchstart", (e)=>{e.preventDefault();fleeNo();},{passive:false});

  // Confetti
  let confetti = [];
  function resizeConfetti(){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
  resizeConfetti();

  function launchConfetti(){
    confettiCanvas.style.display = "block";
    confetti = [];
    for(let i=0;i<220;i++){
      confetti.push({
        x: Math.random()*confettiCanvas.width,
        y: -20 - Math.random()*confettiCanvas.height*0.3,
        r: 2 + Math.random()*4,
        vx: (Math.random()*2-1) * 1.8,
        vy: 2 + Math.random()*4.5,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*2-1)*0.12
      });
    }
    let frames = 0;
    (function tick(){
      frames++;
      ctx2d.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      for(const c of confetti){
        c.x += c.vx; c.y += c.vy; c.rot += c.vr;
        ctx2d.save();
        ctx2d.translate(c.x, c.y);
        ctx2d.rotate(c.rot);
        ctx2d.fillStyle = `hsl(${(c.x + c.y) % 360}, 85%, 65%)`;
        ctx2d.fillRect(-c.r, -c.r, c.r*2.4, c.r*1.2);
        ctx2d.restore();
      }
      confetti = confetti.filter(c => c.y < confettiCanvas.height + 40);
      if(frames < 240 && confetti.length){
        requestAnimationFrame(tick);
      } else {
        ctx2d.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        confettiCanvas.style.display = "none";
      }
    })();
  }

  // Screenshot button (best-effort)
  async function saveScreenshot(){
    try{
      if(!navigator.mediaDevices?.getDisplayMedia) throw new Error("no getDisplayMedia");
      const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
      const track = stream.getVideoTracks()[0];

      let bitmap;
      if("ImageCapture" in window){
        const cap = new ImageCapture(track);
        bitmap = await cap.grabFrame();
      } else {
        const video = document.createElement("video");
        video.srcObject = stream;
        await video.play();
        await new Promise(r=>setTimeout(r, 200));
        const c = document.createElement("canvas");
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext("2d").drawImage(video,0,0);
        bitmap = await createImageBitmap(c);
        video.pause();
      }

      track.stop();
      stream.getTracks().forEach(t=>t.stop());

      const c = document.createElement("canvas");
      c.width = bitmap.width; c.height = bitmap.height;
      c.getContext("2d").drawImage(bitmap,0,0);

      const a = document.createElement("a");
      a.download = "leishas-heart-runner.png";
      a.href = c.toDataURL("image/png");
      a.click();
    } catch(e){
      alert(
        "Screenshot-Download geht im Browser manchmal nicht (file:// / Security).\n\n" +
        "Alternative:\n" +
        "Windows: WIN + SHIFT + S\n" +
        "oder STRG + P ‚Üí Als PDF speichern."
      );
    }
  }
  shotBtn.addEventListener("click", saveScreenshot);

  yesBtn.addEventListener("click", () => {
    // Hide player + HUD when finished
    player.style.display = "none";
    scoreText.style.display = "none";

    question.style.display = "none";
    yesBtn.style.display = "none";
    noBtn.style.display = "none";

    finalMsg.style.display = "block";
    mapCard.style.display = "block";
    infoCard.style.display = "block";
    restartBtn.style.display = "inline-block";
    shotBtn.style.display = "inline-block";

    launchConfetti();

    const q = encodeURIComponent("St. Marx Halle, Wien");
    gmLink.href = `https://www.google.com/maps/search/?api=1&query=${q}`;
    mapFrame.src = `https://www.google.com/maps?q=${q}&output=embed`;
  });

  restartBtn.addEventListener("click", () => location.reload());

  window.addEventListener("resize", () => {
    playerX = Math.min(playerX, window.innerWidth - 58);
    playerY = Math.min(playerY, window.innerHeight - 58);
    resizeConfetti();
  });

  // ---------- Start ----------
  startBtn.addEventListener("click", () => {
    isEndless = (modeSel.value === "endless");
    score = 0;
    targetHearts = 10;

    // set skin before starting
    setSkin(skinSel.value);

    startScreen.style.display = "none";
    player.style.display = "block";
    scoreText.style.display = "block";

    // reset possible end screens
    box.style.display = "none";
    gameOverScreen.style.display = "none";

    gameRunning = true;

    // safe on-screen position
    playerX = Math.max(0, Math.min(window.innerWidth - 58, playerX));
    playerY = Math.max(0, Math.min(window.innerHeight - 58, playerY));
    player.style.left = playerX + "px";
    player.style.top  = playerY + "px";

    startMusic("main");
    updateScore();
    startSpawners();
  });
</script>

</body>
</html>
